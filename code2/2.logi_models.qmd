---
title: "ml_log"
format: html
execute:
  echo: true
  warning: false
  error: false
  freeze: true
  cache: true
editor: visual
---


```{r}

library(tidymodels)
library(themis)
```

```{r}
tidymodels_prefer()
```

### 开启并行

```{r}
library(future)
plan(multisession, workers=8)
nbrOfWorkers() 
``

### 加载数据

```{r}
train_data <- readxl::read_excel('cohort1.xlsx')
test_data <- readxl::read_excel('cohort2.xlsx')
```

```{r}
train_data <- train_data %>%
  mutate(TRG=case_when(TRG %in% c(0,1,2)~ 'R',
                       TRG == 3~ 'NR'),
         TRG = as.factor(TRG))

test_data <- test_data %>%
  mutate(TRG=case_when(TRG %in% c(0,1,2)~ 'R',
                       TRG == 3~ 'NR'),
         TRG = as.factor(TRG))


test_data <- test_data %>% 
  select(colnames(train_data))

```

```{r}

set.seed(123)

```

#### recipe

```{r}
train_data_recipe <- 
  recipe(TRG ~ PGE2+Tryptophan+Histidine+Arginine+Citrulline, data = train_data) %>% 
  step_smote(TRG, 
             over_ratio = 1, 
             neighbors = 3) %>% 
  step_log(c('PGE2','Tryptophan','Histidine','Arginine','Citrulline')) %>% 
  step_zv(all_predictors()) %>% 
  step_normalize(all_numeric_predictors())

train_data_recipe
```

#### models

```{r}

logistic_models <-
  logistic_reg() |>
  set_engine('glm')

logistic_models
```


```{r}
cv_folds <- vfold_cv(
  data = train_data, 
  v = 5, 
  repeats = 5,
  strata = TRG)
```

#### work flow

```{r}
set.seed(123)

log_workflow <- workflow() %>%
  add_recipe(train_data_recipe) %>%
  add_model(logistic_models)

tune_results <- 
  log_workflow %>% 
  fit_resamples(
    resamples = cv_folds,
    metrics = metric_set(roc_auc, accuracy, sens, spec,f_meas,npv,ppv,recall,mcc,kap),
    control = control_grid(save_pred = TRUE, verbose = TRUE))


```

```{r}
tune_results %>% collect_metrics()

cv_results <- tune_results %>% collect_metrics()

write.csv(cv_results,file = 'logistic_models/logi_cv_results.csv')
```

```{r}

show_best(tune_results, metric = "roc_auc")

```

```{r}

best_params <- select_best(tune_results, metric = "roc_auc")
best_params
```

```{r}
final_workflow <- log_workflow %>% 
  finalize_workflow(best_params)

```

```{r}

final_fit <- final_workflow %>% 
  fit(data = train_data)

```

```{r}
test_pred <- predict(final_fit, new_data = test_data)  
test_prob <- predict(final_fit, new_data = test_data, type = "prob")
test_prob
```

```{r}
test_results <- test_data %>%
  select(TRG) %>%
  bind_cols(test_pred, test_prob)
test_results
```


```{r}
test_results <- test_results %>% 
  mutate(TRG = as.factor(TRG))

conf_mat(test_results,truth = TRG,estimate = .pred_class)
```


```{r}
accuracy(test_results,truth = TRG,estimate = .pred_class)
```

```{r}
mcc(test_results,truth = TRG,estimate = .pred_class)
```


```{r}
f_meas(test_results,truth = TRG,estimate = .pred_class)
```

#### PPV

```{r}
ppv(test_results,truth = TRG,estimate = .pred_class)
```

#### AUC

```{r}
roc_auc(test_results,truth = TRG,.pred_NR)
```

#### npv

```{r}
npv(test_results,truth = TRG,.pred_class)

```

#### sens

```{r}
sens(test_results,truth = TRG,estimate = .pred_class)
```

#### spec

```{r}
spec(test_results,truth = TRG,estimate = .pred_class)
```

#### recall

```{r}
recall(test_results,truth = TRG,estimate = .pred_class)
```

```{r}
set.seed(123)
test_ci <- test_data %>%
  bootstraps(times = 1000) %>%
  mutate(
    metrics = map(splits, ~ {
    preds <- augment(final_fit, new_data = analysis(.x))
    list(
    accuracy = accuracy(preds,truth = TRG,estimate = .pred_class),
    mcc = mcc(preds,truth = TRG,estimate = .pred_class),
    f_meas = f_meas(preds,truth = TRG,estimate = .pred_class),
    ppv = ppv(preds,truth = TRG,estimate = .pred_class),
    roc_auc = roc_auc(preds,truth = TRG,.pred_NR),
    npv = npv(preds,truth = TRG,.pred_class),
    sens = sens(preds,truth = TRG,estimate = .pred_class),
    spec = spec(preds,truth = TRG,estimate = .pred_class),
    recall= recall(preds,truth = TRG,estimate = .pred_class)) %>% 
    map_dfr(as_tibble)
  })) %>%
unnest(metrics)


ci <- test_ci %>%
  group_by(.metric) %>%
  summarise(
    mean = mean(.estimate),
    se = sd(.estimate) / sqrt(n()),
    lower = mean - 1.96 * se,
    upper = mean + 1.96 * se,
    .groups = "drop")

ci

```

```{r}
write.csv(ci,file = 'logistic_models/log_ci.csv')
```

```{r}
save(list = ls(),file = 'log.Rdata')
```
